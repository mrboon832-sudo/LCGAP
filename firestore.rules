rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isVerified() {
      return request.auth != null && request.auth.token.email_verified == true;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      
      // Allow create during signup (before email verification)
      allow create: if isAuthenticated() 
        && isOwner(userId)
        && request.resource.data.email == request.auth.token.email;
      
      allow update: if isOwner(userId) || isAdmin();
      
      allow delete: if isAdmin();
      
      // Subcollection for tracking applications by institution
      match /applicationsByInstitution/{institutionId} {
        allow read: if isOwner(userId);
        
        allow write: if isOwner(userId) && isAuthenticated();
      }
    }
    
    // Institutions collection
    match /institutions/{institutionId} {
      allow read: if isAuthenticated();
      
      // Allow create during signup by authenticated users
      allow create: if isAuthenticated() 
        && request.resource.data.createdBy == request.auth.uid;
      
      allow update, delete: if isAdmin() 
        || (isAuthenticated() && resource.data.createdBy == request.auth.uid);
      
      // Faculties subcollection
      match /faculties/{facultyId} {
        allow read: if isAuthenticated();
        
        allow write: if isAdmin() 
          || (isAuthenticated() && get(/databases/$(database)/documents/institutions/$(institutionId)).data.createdBy == request.auth.uid);
        
        // Courses subcollection
        match /courses/{courseId} {
          allow read: if isAuthenticated();
          
          allow write: if isAdmin() 
            || (isAuthenticated() && get(/databases/$(database)/documents/institutions/$(institutionId)).data.createdBy == request.auth.uid);
        }
      }
    }
    
    // Top-level Courses collection (for queries across all institutions)
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      
      // Only allow write if user owns the institution
      allow create: if isVerified()
        && request.resource.data.institutionId is string
        && exists(/databases/$(database)/documents/institutions/$(request.resource.data.institutionId))
        && (isAdmin() || get(/databases/$(database)/documents/institutions/$(request.resource.data.institutionId)).data.createdBy == request.auth.uid);
      
      allow update, delete: if isAuthenticated() && (
        isAdmin()
        || (resource.data.institutionId is string 
            && exists(/databases/$(database)/documents/institutions/$(resource.data.institutionId))
            && get(/databases/$(database)/documents/institutions/$(resource.data.institutionId)).data.createdBy == request.auth.uid)
      );
    }
    
    // Companies collection
    match /companies/{companyId} {
      allow read: if isAuthenticated();
      
      // Allow create during signup by authenticated users
      allow create: if isAuthenticated() 
        && request.resource.data.createdBy == request.auth.uid;
      
      allow update, delete: if isAdmin() 
        || (isAuthenticated() && resource.data.createdBy == request.auth.uid);
    }
    
    // Jobs collection
    match /jobs/{jobId} {
      allow read: if isAuthenticated();
      
      allow create: if isVerified()
        && request.resource.data.companyId is string
        && request.resource.data.title is string
        && request.resource.data.description is string;
      
      // Allow update/delete if admin, or if user owns the job directly (companyId == uid)
      // or if user created the company (for company document IDs)
      allow update, delete: if isAuthenticated() && (
        isAdmin() 
        || resource.data.companyId == request.auth.uid
        || (exists(/databases/$(database)/documents/companies/$(resource.data.companyId)) 
            && get(/databases/$(database)/documents/companies/$(resource.data.companyId)).data.createdBy == request.auth.uid)
      );
    }
    
    // Applications collection - CRITICAL SECURITY
    match /applications/{appId} {
      // Allow read for authenticated users
      allow read: if isAuthenticated();
      
      // Allow create - authenticated users can create their own applications
      allow create: if isAuthenticated()
        && request.auth.uid == request.resource.data.studentId;
      
      // Only institution owner, student (for accepting), or admin can update
      allow update: if isAuthenticated() && (
        isAdmin()
        || resource.data.studentId == request.auth.uid
        || (exists(/databases/$(database)/documents/institutions/$(resource.data.institutionId))
            && get(/databases/$(database)/documents/institutions/$(resource.data.institutionId)).data.createdBy == request.auth.uid)
      );
      
      allow delete: if isAdmin();
    }
    
    // Job Applications collection
    match /jobApplications/{appId} {
      // Single document read
      allow get: if isAuthenticated() && (
        isAdmin()
        || resource.data.studentId == request.auth.uid
        || (exists(/databases/$(database)/documents/jobs/$(resource.data.jobId))
            && (get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId == request.auth.uid
                || (exists(/databases/$(database)/documents/companies/$(get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId)) 
                    && get(/databases/$(database)/documents/companies/$(get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId)).data.createdBy == request.auth.uid)))
      );
      
      // List queries - allow authenticated users, filter in application code
      allow list: if isAuthenticated();
      
      // Allow create for verified students (removed deterministic ID requirement)
      allow create: if isAuthenticated()
        && request.auth.uid == request.resource.data.studentId
        && request.resource.data.status == 'pending'
        && request.resource.data.jobId is string
        && request.resource.data.studentId is string;
      
      // Allow update if admin, job's companyId matches user, or user created the company
      allow update: if isAuthenticated() && (
        isAdmin()
        || (exists(/databases/$(database)/documents/jobs/$(resource.data.jobId))
            && (get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId == request.auth.uid
                || (exists(/databases/$(database)/documents/companies/$(get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId)) 
                    && get(/databases/$(database)/documents/companies/$(get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.companyId)).data.createdBy == request.auth.uid)))
      );
      
      allow delete: if isAdmin() || resource.data.studentId == request.auth.uid;
    }
    
    // Transcripts/documents metadata
    match /transcripts/{studentId}/{fileId} {
      allow read: if isAuthenticated() && (
        isAdmin()
        || isOwner(studentId)
      );
      
      allow create: if isVerified() 
        && isOwner(studentId)
        && request.resource.data.studentId == studentId;
      
      allow update: if isOwner(studentId) || isAdmin();
      
      allow delete: if isOwner(studentId) || isAdmin();
    }
    
    // Notifications (optional)
    match /notifications/{userId}/inbox/{noteId} {
      allow read: if isOwner(userId);
      
      allow create: if isAuthenticated();
      
      allow update, delete: if isOwner(userId);
    }
  }
}
